<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Staff Roster Editor</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-static@latest/umd/lucide.js"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        .roster-container::-webkit-scrollbar { height: 8px; }
        .roster-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .roster-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .roster-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dragging { opacity: 0.5; transform: scale(0.95); }
        .drag-over { outline: 2px dashed #3b82f6; outline-offset: -2px; background-color: #eff6ff; }
        [draggable="true"] { cursor: grab; }
        [draggable="true"]:active { cursor: grabbing; }
        .modal-backdrop {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-6 lg:p-8">

    <div class="w-full max-w-screen-2xl mx-auto">
        <div class="p-6 bg-white rounded-xl shadow-lg mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Weekly Roster Editor</h1>
                    <p id="roster-date-range" class="text-gray-500 mt-1"></p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="share-button" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 transition-colors flex items-center gap-2">
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                        Share / Embed
                    </button>
                    <div class="flex-shrink-0">
                        <label for="start-date-picker" class="block text-sm font-medium text-gray-700 mb-1">Start of Week</label>
                        <input type="date" id="start-date-picker" class="p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Staff Palette -->
            <aside class="lg:w-72 bg-white rounded-xl shadow-lg p-6 h-fit">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Staff Management</h2>
                <p class="text-sm text-gray-500 mb-4 -mt-2">Right-click a name to remove.</p>
                <form id="add-staff-form" class="flex gap-2 mb-4">
                    <input type="text" id="new-staff-name" placeholder="Add new staff..." class="flex-grow p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" required>
                    <input type="color" id="new-staff-color" value="#a3a3a3" class="p-1 h-10 w-10 border border-gray-300 rounded-md cursor-pointer">
                    <button type="submit" class="bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                    </button>
                </form>
                <div id="staff-palette" class="space-y-3">
                    <!-- Draggable staff names will be generated here -->
                </div>
            </aside>

            <!-- Roster -->
            <main class="flex-1">
                <div class="w-full bg-white rounded-xl shadow-lg overflow-hidden">
                    <div id="roster-container" class="roster-container overflow-x-auto">
                        <!-- Roster will be generated here -->
                    </div>
                </div>
                <!-- Notes Section -->
                <div class="w-full bg-white rounded-xl shadow-lg overflow-hidden mt-8">
                     <h2 class="text-xl font-bold text-gray-800 p-6 border-b">Daily Notes</h2>
                    <div id="notes-container" class="grid grid-cols-1 md:grid-cols-7">
                        <!-- Notes textareas will be generated here -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="share-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 z-50 modal-backdrop opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Share or Embed Your Roster</h2>
                <button id="close-modal-button" class="text-gray-500 hover:text-gray-800">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <p class="text-gray-600 mb-4">Use the link for sharing, or copy the HTML code to embed this roster on a website like Google Sites.</p>
            
            <div class="mb-6">
                <label for="share-link" class="block text-sm font-medium text-gray-700 mb-1">Shareable Link (View-Only)</label>
                <input id="share-link" type="text" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-50">
            </div>

            <div>
                <label for="embed-code" class="block text-sm font-medium text-gray-700 mb-1">Embed Code</label>
                <textarea id="embed-code" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-50 h-32 resize-none"></textarea>
            </div>
            <div class="mt-4 text-right">
                <button id="copy-embed-code" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center gap-2 ml-auto">
                    <i data-lucide="copy" class="w-5 h-5"></i>
                    <span id="copy-button-text">Copy Code</span>
                </button>
            </div>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Data Model ---
        let staffMembers = [];
        let rosterData = {};

        // --- State for Drag & Drop ---
        let draggedItem = null;

        // --- DOM Elements ---
        const staffPalette = document.getElementById('staff-palette');
        const rosterContainer = document.getElementById('roster-container');
        const notesContainer = document.getElementById('notes-container');
        const rosterDateRangeEl = document.getElementById('roster-date-range');
        const datePicker = document.getElementById('start-date-picker');
        const addStaffForm = document.getElementById('add-staff-form');
        const newStaffNameInput = document.getElementById('new-staff-name');
        const newStaffColorInput = document.getElementById('new-staff-color');
        // Modal elements
        const shareButton = document.getElementById('share-button');
        const shareModal = document.getElementById('share-modal');
        const closeModalButton = document.getElementById('close-modal-button');
        const shareLinkInput = document.getElementById('share-link');
        const embedCodeTextarea = document.getElementById('embed-code');
        const copyEmbedCodeButton = document.getElementById('copy-embed-code');
        const copyButtonText = document.getElementById('copy-button-text');


        // --- Data Persistence ---
        function saveDataToLocalStorage() {
            const appData = { staffMembers, rosterData };
            localStorage.setItem('rosterAppData', JSON.stringify(appData));
        }

        function loadDataFromLocalStorage() {
            const savedData = localStorage.getItem('rosterAppData');
            if (savedData) {
                const appData = JSON.parse(savedData);
                staffMembers = appData.staffMembers || [];
                rosterData = appData.rosterData || createDefaultRosterData();
            } else {
                // If no saved data, load defaults
                staffMembers = [
                    { name: 'Chrissy', color: '#60a5fa' }, { name: 'Gemma', color: '#f87171' },
                    { name: 'Jodie', color: '#4ade80' }, { name: 'Niamh', color: '#fbbf24' },
                    { name: 'Julie', color: '#a78bfa' }, { name: 'MacKenzie', color: '#34d399' },
                    { name: 'India', color: '#f472b6' }, { name: 'Zack', color: '#fb923c' },
                    { name: 'Charlie', color: '#2dd4bf' }, { name: 'Else', color: '#a3a3a3' },
                    { name: 'Simon', color: '#93c5fd' }, { name: 'Alex', color: '#c084fc' }
                ];
                rosterData = createDefaultRosterData();
            }
        }

        function createDefaultRosterData() {
            const createEmptySchedule = () => Array.from({ length: 20 }, () => Array(7).fill(''));
            return {
                startDate: '2025-04-21',
                schedule: createEmptySchedule(),
                notes: Array(7).fill('')
            };
        }

        // --- Helper Functions ---
        function getContrastingTextColor(hexcolor) {
            if (!hexcolor) return '#000000';
            hexcolor = hexcolor.replace("#", "");
            const r = parseInt(hexcolor.substr(0, 2), 16);
            const g = parseInt(hexcolor.substr(2, 2), 16);
            const b = parseInt(hexcolor.substr(4, 2), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 128) ? '#1f2937' : '#ffffff';
        }
        
        // --- Main Render Function ---
        function render() {
            renderDateDisplay();
            renderStaffPalette();
            renderRosterGrid();
            renderNotes();
            lucide.createIcons();
        }

        function renderDateDisplay() {
            const startDate = new Date(rosterData.startDate + 'T00:00:00');
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);
            const dateFormatter = new Intl.DateTimeFormat('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            rosterDateRangeEl.textContent = `${dateFormatter.format(startDate)} - ${dateFormatter.format(endDate)}`;
            datePicker.value = rosterData.startDate;
        }

        function renderStaffPalette() {
            staffPalette.innerHTML = ''; 
            staffMembers.forEach(staff => {
                const staffEl = createDraggableName(staff.name, 'palette');
                staffPalette.appendChild(staffEl);
            });
            const removeEl = createDraggableName('Remove', 'palette');
            staffPalette.appendChild(removeEl);
        }

        function renderRosterGrid() {
            rosterContainer.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-7 min-w-[1200px]';
            
            const headerRow = createHeader();
            grid.appendChild(headerRow);
            
            rosterData.schedule.forEach((row, rowIndex) => {
                row.forEach((name, colIndex) => {
                    const cell = createDroppableCell(rowIndex, colIndex);
                    grid.appendChild(cell);
                });
            });
            rosterContainer.appendChild(grid);
        }

        function renderNotes() {
            notesContainer.innerHTML = '';
            for(let i = 0; i < 7; i++) {
                const noteWrapper = document.createElement('div');
                noteWrapper.className = 'p-4 border-b md:border-b-0 md:border-r border-gray-200';

                const textArea = document.createElement('textarea');
                textArea.className = 'w-full h-24 p-2 border border-gray-200 rounded-md resize-none focus:ring-blue-500 focus:border-blue-500';
                textArea.placeholder = `Notes for day ${i + 1}...`;
                textArea.value = rosterData.notes[i] || '';
                textArea.addEventListener('input', (e) => {
                    rosterData.notes[i] = e.target.value;
                    saveDataToLocalStorage();
                });
                
                noteWrapper.appendChild(textArea);
                notesContainer.appendChild(noteWrapper);
            }
        }

        // --- Element Creation Helpers ---
        function createHeader() {
            const headerRow = document.createElement('div');
            headerRow.className = 'col-span-7 grid grid-cols-7 sticky top-0 bg-white z-10';
            const startDate = new Date(rosterData.startDate + 'T00:00:00');
            const dayFormatter = new Intl.DateTimeFormat('en-US', { weekday: 'short', day: '2-digit', month: 'short' });
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const parts = dayFormatter.formatToParts(currentDate);
                const weekday = parts.find(p => p.type === 'weekday').value;
                const day = parts.find(p => p.type === 'day').value;
                const month = parts.find(p => p.type === 'month').value;
                const dayCell = document.createElement('div');
                dayCell.className = 'text-center font-semibold text-gray-700 p-3 border-b-2 border-r border-gray-200';
                dayCell.textContent = `${weekday} ${day} ${month}`;
                headerRow.appendChild(dayCell);
            }
            return headerRow;
        }

        function createDraggableName(name, type, data = {}) {
            const el = document.createElement('div');
            el.draggable = true;
            el.addEventListener('dragstart', (e) => handleDragStart(e, name, type, data));
            el.addEventListener('dragend', handleDragEnd);

            const nameSpan = document.createElement('span');
            nameSpan.textContent = name;

            const staffMember = staffMembers.find(s => s.name === name);

            if (type === 'cell' && staffMember) {
                el.className = 'w-full h-full flex items-center justify-center rounded-md text-sm font-medium transition-all';
                el.style.backgroundColor = staffMember.color;
                el.style.color = getContrastingTextColor(staffMember.color);
                el.appendChild(nameSpan);
            } else if (type === 'palette') {
                el.className = 'p-2 rounded-md font-medium text-center transition-all flex justify-between items-center group';
                if (name === 'Remove') {
                    el.classList.add('bg-red-200', 'text-red-800');
                    el.appendChild(nameSpan);
                } else if (staffMember) {
                    el.classList.add('bg-gray-200', 'text-gray-800');
                    el.appendChild(nameSpan);

                    el.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        handleRemoveStaff(name);
                    });

                    const controlsWrapper = document.createElement('div');
                    controlsWrapper.className = 'flex items-center gap-2';
                    const colorPickerLabel = document.createElement('label');
                    colorPickerLabel.className = 'relative w-6 h-6 rounded-full border-2 border-white shadow-sm cursor-pointer';
                    colorPickerLabel.style.backgroundColor = staffMember.color;
                    const colorInput = document.createElement('input');
                    colorInput.type = 'color';
                    colorInput.value = staffMember.color;
                    colorInput.className = 'absolute inset-0 w-full h-full opacity-0 cursor-pointer';
                    colorInput.addEventListener('input', (e) => {
                        colorPickerLabel.style.backgroundColor = e.target.value;
                    });
                    colorInput.addEventListener('change', (e) => {
                        staffMember.color = e.target.value;
                        render();
                        saveDataToLocalStorage();
                    });
                    colorPickerLabel.appendChild(colorInput);
                    controlsWrapper.appendChild(colorPickerLabel);
                    el.appendChild(controlsWrapper);
                }
            }
            return el;
        }
        
        function createDroppableCell(rowIndex, colIndex) {
            const cell = document.createElement('div');
            const name = rosterData.schedule[rowIndex][colIndex];
            cell.className = `h-16 flex items-center justify-center p-1 border-b border-r border-gray-200 transition-colors`;
            
            cell.addEventListener('dragover', handleDragOver);
            cell.addEventListener('dragleave', handleDragLeave);
            cell.addEventListener('drop', (e) => handleDrop(e, rowIndex, colIndex));

            if (name) {
                const data = { rowIndex, colIndex };
                const nameEl = createDraggableName(name, 'cell', data);
                cell.appendChild(nameEl);
            }
            return cell;
        }

        // --- Event Handlers ---
        function handleAddStaff(e) {
            e.preventDefault();
            const newName = newStaffNameInput.value.trim();
            const newColor = newStaffColorInput.value;
            if (newName && !staffMembers.some(staff => staff.name === newName)) {
                staffMembers.push({ name: newName, color: newColor });
                staffMembers.sort((a, b) => a.name.localeCompare(b.name));
                render();
                saveDataToLocalStorage();
            }
            newStaffNameInput.value = '';
        }

        function handleRemoveStaff(nameToRemove) {
            staffMembers = staffMembers.filter(staff => staff.name !== nameToRemove);
            rosterData.schedule = rosterData.schedule.map(row => 
                row.map(name => (name === nameToRemove ? '' : name))
            );
            render();
            saveDataToLocalStorage();
        }

        function handleDragStart(e, name, type, data) {
            draggedItem = { name, type, data };
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', name);
            setTimeout(() => e.target.closest('[draggable="true"]').classList.add('dragging'), 0);
        }

        function handleDragEnd(e) {
            const draggable = e.target.closest('[draggable="true"]');
            if(draggable) draggable.classList.remove('dragging');
            draggedItem = null;
        }

        function handleDragOver(e) { e.preventDefault(); e.target.closest('div[class*="border-b"]')?.classList.add('drag-over'); }
        function handleDragLeave(e) { e.target.closest('div[class*="border-b"]')?.classList.remove('drag-over'); }

        function handleDrop(e, targetRowIndex, targetColIndex) {
            e.preventDefault();
            e.target.closest('div[class*="border-b"]')?.classList.remove('drag-over');
            if (!draggedItem) return;
            const newName = draggedItem.name === 'Remove' ? '' : draggedItem.name;
            if (draggedItem.type === 'cell') {
                rosterData.schedule[draggedItem.data.rowIndex][draggedItem.data.colIndex] = '';
            }
            rosterData.schedule[targetRowIndex][targetColIndex] = newName;
            render();
            saveDataToLocalStorage();
        }
        
        // --- Modal Logic ---
        function openShareModal() {
            const viewerUrl = new URL('roster-viewer.html', window.location.href).href;
            shareLinkInput.value = viewerUrl;
            embedCodeTextarea.value = `<iframe src="${viewerUrl}" style="border:0; width:100%; height:800px;" allowfullscreen="" loading="lazy"></iframe>`;
            
            shareModal.classList.remove('opacity-0', 'pointer-events-none');
            shareModal.querySelector('div[class*="transform"]').classList.remove('scale-95');
        }

        function closeShareModal() {
            shareModal.classList.add('opacity-0', 'pointer-events-none');
            shareModal.querySelector('div[class*="transform"]').classList.add('scale-95');
        }

        // --- Initial Load ---
        loadDataFromLocalStorage();
        render();

        // --- Event Listeners ---
        datePicker.addEventListener('change', (e) => {
            rosterData.startDate = e.target.value;
            render();
            saveDataToLocalStorage();
});
        addStaffForm.addEventListener('submit', handleAddStaff);
        shareButton.addEventListener('click', openShareModal);
        closeModalButton.addEventListener('click', closeShareModal);
        shareModal.addEventListener('click', (e) => {
            if (e.target === shareModal) closeShareModal();
        });
        copyEmbedCodeButton.addEventListener('click', () => {
            embedCodeTextarea.select();
            document.execCommand('copy');
            copyButtonText.textContent = 'Copied!';
            setTimeout(() => { copyButtonText.textContent = 'Copy Code'; }, 2000);
        });
    });
    </script>
</body>
</html>
